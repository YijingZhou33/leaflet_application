<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Webmap 201</title>
        <!-- Style -->
        <link rel="stylesheet" href="src/leaflet.css">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
        <link rel="stylesheet" href="src/plugins/L.Control.Pan.css">
        <link rel="stylesheet" href="src/plugins/L.Control.Zoomslider.css">
        <link rel="stylesheet" href="src/plugins/L.Control.MousePosition.css">
        <link rel="stylesheet" href="src/plugins/Leaflet.PolylineMeasure.css">
        <link rel="stylesheet" href="src/plugins/easy-button.css">
        <link rel="stylesheet" href="src/plugins/L.Control.Sidebar.css">
        <link rel="stylesheet" href="src/plugins/leaflet-opencage/src/css/L.Control.OpenCageSearch.css">
        <link rel="stylesheet" href="src/plugins/leaflet-styleeditor/css/Leaflet.StyleEditor.css">
        <link rel="stylesheet" href="src/css/all.min.css">
        <link rel="stylesheet" href="src/plugins/leaflet.awesome-markers.css">
        <link rel="stylesheet" href="src/plugins/leaflet-mapkey/MapkeyIcons.css">
        <link rel="stylesheet" href="src/plugins/leaflet-mapkey/L.Icon.Mapkey.css">
        <link rel="stylesheet" href="src/plugins/MarkerCluster.css">
        <link rel="stylesheet" href="src/plugins/MarkerCluster.Default.css">
        <link rel="stylesheet" href="src/jquery-ui.min.css">
        <link rel="stylesheet" href="src/plugins/leaflet-legend.css">
        
        <!-- JavaScript -->
        <script src="src/leaflet-src.js"></script>
        <script src="src/jquery-3.5.1.min.js"></script>
        <script src="src/plugins/L.Control.Pan.js"></script>
        <script src="src/plugins/L.Control.Zoomslider.js"></script>
        <script src="src/plugins/L.Control.MousePosition.js"></script>
        <script src="src/plugins/Leaflet.PolylineMeasure.js"></script>
        <script src="src/plugins/easy-button.js"></script>
        <script src="src/plugins/L.Control.Sidebar.js"></script>
        <script src="src/plugins/leaflet-opencage/src/js/L.Control.OpenCageSearch.js"></script>
        <script src="src/plugins/leaflet-providers.js"></script>
        <script src="src/plugins/leaflet-styleeditor/javascript/Leaflet.StyleEditor.js"></script>
        <script src="src/plugins/leaflet.ajax.min.js"></script>
        <script src="src/plugins/leaflet.sprite.js"></script>
        <script src="src/plugins/leaflet.awesome-markers.min.js"></script>
        <script src="src/plugins/leaflet-mapkey/L.Icon.Mapkey.js"></script>
        <script src="src/plugins/leaflet.markercluster.js"></script>
        <script src="src/jquery-ui.js"></script>
        <script src="src/plugins/leaflet.geometryutil.js"></script>
        <script src='https://unpkg.com/@turf/turf@6.2.0-alpha.1/dist/turf.min.js'></script>
        <script src="src/plugins/leaflet-legend.js"></script>
        
        <!-- Begin Leaflet.Draw -->         
        <script src="src/plugins/leaflet-draw/Leaflet.draw.js"></script> 
        <script src="src/plugins/leaflet-draw/Leaflet.Draw.Event.js"></script> 
        <link rel="stylesheet" href="src/plugins/leaflet-draw/leaflet.draw.css"/> 
        <script src="src/plugins/leaflet-draw/Toolbar.js"></script> 
        <script src="src/plugins/leaflet-draw/Tooltip.js"></script> 
        <script src="src/plugins/leaflet-draw/ext/GeometryUtil.js"></script> 
        <script src="src/plugins/leaflet-draw/ext/LatLngUtil.js"></script> 
        <script src="src/plugins/leaflet-draw/ext/LineUtil.Intersect.js"></script> 
        <script src="src/plugins/leaflet-draw/ext/Polygon.Intersect.js"></script> 
        <script src="src/plugins/leaflet-draw/ext/Polyline.Intersect.js"></script> 
        <script src="src/plugins/leaflet-draw/ext/TouchEvents.js"></script> 
        <script src="src/plugins/leaflet-draw/draw/DrawToolbar.js"></script> 
        <script src="src/plugins/leaflet-draw/draw/handler/Draw.Feature.js"></script> 
        <script src="src/plugins/leaflet-draw/draw/handler/Draw.SimpleShape.js"></script> 
        <script src="src/plugins/leaflet-draw/draw/handler/Draw.Polyline.js"></script> 
        <script src="src/plugins/leaflet-draw/draw/handler/Draw.Circle.js"></script> 
        <script src="src/plugins/leaflet-draw/draw/handler/Draw.Marker.js"></script> 
        <script src="src/plugins/leaflet-draw/draw/handler/Draw.Polygon.js"></script> 
        <script src="src/plugins/leaflet-draw/draw/handler/Draw.Rectangle.js"></script> 
        <script src="src/plugins/leaflet-draw/draw/handler/Draw.CircleMarker.js"></script> 
        <script src="src/plugins/leaflet-draw/edit/EditToolbar.js"></script> 
        <script src="src/plugins/leaflet-draw/edit/handler/EditToolbar.Edit.js"></script> 
        <script src="src/plugins/leaflet-draw/edit/handler/EditToolbar.Delete.js"></script> 
        <script src="src/plugins/leaflet-draw/Control.Draw.js"></script> 
        <script src="src/plugins/leaflet-draw/edit/handler/Edit.Poly.js"></script> 
        <script src="src/plugins/leaflet-draw/edit/handler/Edit.SimpleShape.js"></script> 
        <script src="src/plugins/leaflet-draw/edit/handler/Edit.CircleMarker.js"></script> 
        <script src="src/plugins/leaflet-draw/edit/handler/Edit.Circle.js"></script> 
        <script src="src/plugins/leaflet-draw/edit/handler/Edit.Rectangle.js"></script> 
        <script src="src/plugins/leaflet-draw/edit/handler/Edit.Marker.js"></script> 
        <!-- End of Lealet Draw -->

        <style>
            #mapdiv{
                /* vh: viewport takes up the whole screen*/
                height:100vh;
            }
            
            .col-xs-12, .col-xs-6, .col-xs-4 {
                padding: 3px;
            }
            
            #divProject, #divBUOWL, #divEagle, #divRaptor {
                background-color: beige;
            }
            
            .errorMsg {
                padding: 0;
                text-align: center;
                background-color: indianred;
                visibility: hidden;
            }
            
            .ui-menu {
                max-height: 50px;
                overflow-y: auto;
                overflow-x: hidden;
            }
            
        </style>
    </head>
    <body>

        <div id="side-bar">
            <button id="btnLocate" class="btn btn-primary btn-block">Locate</button>
            <button id="btnShowLegend" class="btn btn-primary btn-block">Show Legend</button>
            <div id="legend" style="display:none;">
                <!-- Linear Projects -->
                <h5>Linear Projects <i id="btnLinearProjects" class="fa fa-server"></i></h5>
                <div id="legendLinearProjectsDetail" style="display:none;">
                    <svg height="270" width="100%">
                        <line x1="10" y1="10" x2="40" y2="10" style="stroke:peru; stroke-width:2;"/>
                        <text x="50" y="15" style="font-family: sans-serif;font-size:16px">Pipeline</text>
                        <line x1="10" y1="40" x2="40" y2="40" style="stroke:navy; stroke-width:2;"/>
                        <text x="50" y="45" style="font-family: sans-serif;font-size:16px">Flowline</text>
                        <line x1="10" y1="70" x2="40" y2="70" style="stroke:navy; stroke-width:2;stroke-dasharray:5,5;"/>
                        <text x="50" y="75" style="font-family: sans-serif;font-size:16px">Flowline - Estimated</text>
                        <line x1="10" y1="100" x2="40" y2="100" style="stroke:darkgreen; stroke-width:2;"/>
                        <text x="50" y="105" style="font-family: sans-serif;font-size:16px">Electric Line</text>
                        <line x1="10" y1="130" x2="40" y2="130" style="stroke:darkred; stroke-width:2;"/>
                        <text x="50" y="135" style="font-family: sans-serif;font-size:16px">Access Road - Confirmed</text>
                        <line x1="10" y1="160" x2="40" y2="160" style="stroke:darkred; stroke-width:2;stroke-dasharray:5,5;"/>
                        <text x="50" y="165" style="font-family: sans-serif;font-size:16px">Access Road - Estimated</text>
                        <line x1="10" y1="190" x2="40" y2="190" style="stroke:indigo; stroke-width:2;"/>
                        <text x="50" y="195" style="font-family: sans-serif;font-size:16px">Extraction</text>
                        <line x1="10" y1="220" x2="40" y2="220" style="stroke:darkgoldenrod; stroke-width:2;"/>
                        <text x="50" y="225" style="font-family: sans-serif;font-size:16px">Other</text>
                        <rect x="10" y="240" width="30" height="20" style="stroke:gray; stroke-width:4;stroke-dasharray:5,5;fill:yellow;fill-opacity:0.0;"/>
                        <text x="50" y="255" style="font-family: sans-serif;font-size:16px">Right-of-way</text>
                    </svg>
                </div>
                <!-- Burrowing Owl Habitat -->
                <h5>Burrowing Owl Habitat <i id="btnBUOWL" class="fa fa-server"></i></h5>
                <div id="legendBUOWLDetail" style="display:none;">
                     <svg height="90" width="100%">
                        <rect x="10" y="5" width="30" height="20" style="stroke:deeppink; stroke-width:4;fill:yellow;fill-opacity:0.5;"/>
                        <text x="50" y="20" style="font-family: sans-serif;font-size:16px">Historically Occupied</text>
                        <rect x="10" y="35" width="30" height="20" style="stroke:yellow; stroke-width:4;fill:yellow;fill-opacity:0.5;"/>
                        <text x="50" y="50" style="font-family: sans-serif;font-size:16px">Not Historically Occupied</text>
                        <rect x="10" y="65" width="30" height="20" style="stroke:coral; stroke-width:4;fill:yellow;stroke-dasharray:5,5;fill-opacity:0.0;"/>
                        <text x="50" y="80" style="font-family: sans-serif;font-size:16px">300m Buffer</text>
                    </svg>                   
                </div>
                <!-- Eagle Nest -->
                <h5>Eagle Nest <i id="btnEagle" class="fa fa-server"></i></h5>
                <div id="legendEagleDetail" style="display:none;">
                     <svg height="60" width="100%">
                        <circle cx="20" cy="15" r="10" style="stroke:lightpink; stroke-width:4;fill:darkolivegreen;fill-opacity:0.5;"/>
                        <text x="50" y="20" style="font-family: sans-serif;font-size:16px">Active Nest</text>
                        <circle cx="20" cy="45" r="10" style="stroke:olivedrab; stroke-width:4;fill:darkolivegreen;fill-opacity:0.5;"/>
                        <text x="50" y="50" style="font-family: sans-serif;font-size:16px">Inactive Location</text>
                    </svg>                   
                </div>
                <!-- Raper Nest -->
                <h5>Raper Nest <i id="btnRaptor" class="fa fa-server"></i></h5>
                <div id="legendRaptorDetail" style="display:none;">
                     <svg height="90" width="100%">
                        <circle cx="20" cy="15" r="10" style="stroke:indianred; stroke-width:4;fill:blue;fill-opacity:0.5;"/>
                        <text x="50" y="20" style="font-family: sans-serif;font-size:16px">Active Nest</text>
                        <circle cx="20" cy="45" r="10" style="stroke:blue; stroke-width:4;fill:blue;fill-opacity:0.5;"/>
                        <text x="50" y="50" style="font-family: sans-serif;font-size:16px">Inactive Nest</text>
                        <circle cx="20" cy="75" r="10" style="stroke:blue; stroke-width:4;fill:blue;fill-opacity:0.5;stroke-dasharray:5,5;"/>
                        <text x="50" y="80" style="font-family: sans-serif;font-size:16px">Inactive Location</text>
                    </svg>                   
                </div>
            </div><br>
            <button id="btnClear" class="btn btn-primary btn-block">Clear</button><br>
            <div id="divProject" class="col-xs-12">
                <div id="divProjectLabel" class="text-center col-xs-12">
                    <h4 id="lblProject">Linear Projects</h4>
                </div>
                <div id="divProjectError" class="errorMsg col-xs-12">Project ID Not Found</div>
                <div id="divFindProject" class="form-group">
                    <div class="col-xs-6">
                        <input type="text" id="txtFindProject" class="form-control" placeholder="Project ID">
                    </div>
                    <div class="col-xs-6">
                        <button id="btnFindProject" class="btn btn-primary btn-block" disabled>Find Project</button>
                    </div>
                </div>
                <div id="divFilterProject" class="col-xs-12">
                    <div class="col-xs-4">
                        <input type="checkbox" name="fltProject" value="Pipeline" checked>Pipelines<br>
                        <input type="checkbox" name="fltProject" value="Road" checked>Access Roads
                        <button id="btnProjectFilterAll" class="btn btn-primary btn-block">Check All</button>
                    </div>
                    <div class="col-xs-4">
                        <input type="checkbox" name="fltProject" value="Electric" checked>Electric Lines<br>
                        <input type="checkbox" name="fltProject" value="Extraction" checked>Extractions
                        <button id="btnProjectFilterNone" class="btn btn-primary btn-block">Uncheck All</button>
                    </div>
                    <div class="col-xs-4">
                        <input type="checkbox" name="fltProject" value="Flowline" checked>Flowlines<br>
                        <input type="checkbox" name="fltProject" value="Other" checked>Other
                        <button id="btnProjectFilter" class="btn btn-primary btn-block">Filter</button>
                    </div>
                </div>
                <div id="divProjectData" class=""></div>
            </div>
            <div id="divBUOWL" class="col-xs-12">
                <div id="divBUOWLLabel" class="text-center col-xs-12">
                    <h4 id="lblBUOWL">BUOWL Habitat</h4>
                </div>
                <div id="divBUOWLError" class="errorMsg col-xs-12">Habitat ID Not Found</div>
                <div id="divFindBUOWL" class="form-group">
                    <div class="col-xs-6">
                        <input type="text" id="txtFindBUOWL" class="form-control" placeholder="Habitat ID">
                    </div>
                    <div class="col-xs-6">
                        <button id="btnFindBUOWL" class="btn btn-primary btn-block" disabled>Find BUOWL</button>
                    </div>
                </div>
                <div id="divFilterBUOWL" class="col-xs-12">
                    <div class="col-xs-2">
                        <input type='radio' name='fltBUOWL' value='ALL' checked>All
                    </div>
                    <div class="col-xs-6">
                        <input type='radio' name='fltBUOWL' value='Yes'>Historically Occupied
                    </div>
                    <div class="col-xs-4">
                        <input type='radio' name='fltBUOWL' value='Undetermined'>Undetermined
                    </div>
                </div>
                <div class="" id="divBUOWLData"></div>
            </div>
            <div id="divEagle" class="col-xs-12">
                <div id="divEagleLabel" class="text-center col-xs-12">
                    <h4 id="lblEagle">Eagle Nests</h4>
                </div>
                <div id="divEagleError" class="errorMsg col-xs-12">Eagle Nest ID Not Found</div>
                <div id="divFindEagle" class="form-group">
                    <div class="col-xs-6">
                        <input type="text" id="txtFindEagle" class="form-control" placeholder="Eagle Nest ID">
                    </div>
                    <div class="col-xs-6">
                        <button id="btnFindEagle" class="btn btn-primary btn-block" disabled>Find Eagle Nest</button>
                    </div>
                </div>
                <div id="divFilterEagle" class="col-xs-12">
                    <div class="col-xs-4">
                        <input type="radio" name="fltEagle" value="ALL" checked>All
                    </div>
                    <div class="col-xs-4">
                        <input type="radio" name="fltEagle" value="ACTIVE NEST" >Active
                    </div>
                    <div class="col-xs-4">
                        <input type="radio" name="fltEagle" value="INACTIVE LOCATION" >Inactive
                    </div>
                </div>
                <div class="" id="divEagleData"></div>
            </div>
            <div id="divRaptor" class="col-xs-12">
                <div id="divRaptorLabel" class="text-center col-xs-12">
                    <h4 id="lblRaptor">Raptor Nests</h4>
                </div>
                <div id="divRaptorError" class="errorMsg col-xs-12">Raptor Nest Not Found</div>
                <div id="divFindRaptor" class="form-group">
                    <div class="col-xs-6">
                        <input type="text" id="txtFindRaptor" class="form-control" placeholder="Raptor Nest ID">
                    </div>
                    <div class="col-xs-6">
                        <button id="btnFindRaptor" class="btn btn-primary btn-block" disabled>Find Raptor Nest</button>
                    </div>
                </div>
                <div id="divFilterRaptor" class="col-xs-12">
                    <div class="col-xs-3">
                        <input type='radio' name='fltRaptor' value='ALL' checked>All
                    </div>
                    <div class="col-xs-3">
                        <input type='radio' name='fltRaptor' value='ACTIVE NEST'>Active
                    </div>
                    <div class="col-xs-3">
                        <input type='radio' name='fltRaptor' value='INACTIVE NEST'>Inactive
                    </div>
                    <div class="col-xs-3">
                        <input type='radio' name='fltRaptor' value='FLEDGED NEST'>Fledged
                    </div>
                </div>
                <div class="" id="divRaptorData"></div>
            </div>
        </div>
        <div id="mapdiv" class="col-12 float-right"></div>
        <script>
            var mymap; 
            var lyrOSM;
            var lyrWaterColor;
            var lyrTopo;
            var lyrImagery;
            var lyrOutdoors;
            var lyrMapBox;
            var lyrEagleNests;
            var lyrRaptorNests;
            var lyrMarkerCluster;
            var lyrClientLines;
            var lyrClientLinesBuffer;
            var lyrBUOWL;
            var lyrBUOWLbuffer;
            var lyrGBH;
            var lyrSearch;
            var mrkCurrentLocation;
            var fgpDrawnItems;
            var ctlAttribute;
            var ctlMousePosition;
            var ctlSidebar;
            var ctlEasyButton;
            var ctlMeasure;
            var ctlLayers;
            var ctlDraw;
            var ctlStyle;
            var ctlLegend;
            var objBasemaps;
            var objOverlays;
            var arProjectIDs = [];
            var arProjectFilters = [];
            var arHabitatIDs = [];
            var arEagleIDs = [];
            var arRaptorIDs = [];
            
            $(document).ready(function(){ 
                
                /********** Map Initialization **********/
                mymap = L.map('mapdiv', 
                                {
                                    center: [40.18, -104.83], 
                                    zoom: 11,
                                    attributionControl: false,
                                }
                             );
                setInterval(function () {
                        mymap.invalidateSize();
                }, 100);
                
                ctlSidebar = L.control.sidebar('side-bar').addTo(mymap);
                
                ctlAttribute = L.control.attribution({position: 'bottomleft'});
                ctlAttribute.addAttribution('OSM');
                ctlAttribute.addAttribution('<a href="http://yijingzhou.com">http://yijingzhou.com</a>')
                ctlAttribute.addTo(mymap);
                             
                ctlMousePosition = L.control.mousePosition().addTo(mymap);
 
                ctlEasyButton = L.easyButton('glyphicon-transfer', function(){ctlSidebar.toggle();}).addTo(mymap);
                
                ctlMeasure = L.control.polylineMeasure().addTo(mymap);
                
                ctlStyle = L.control.styleEditor({openOnLeafletDraw: false}).addTo(mymap);
                
                /********** Layer Initialization **********/
            
                lyrOSM = L.tileLayer.provider('OpenStreetMap.Mapnik');
                lyrWaterColor = L.tileLayer.provider('Stamen.Watercolor');
                lyrTopo = L.tileLayer.provider('OpenTopoMap');
                lyrOutdoors = L.tileLayer.provider('Thunderforest.Outdoors');
                lyrImagery = L.tileLayer.provider('Esri.WorldImagery');
                mymap.addLayer(lyrOSM);
                
                fgpDrawnItems = L.featureGroup().addTo(mymap);
                
                /********** Layer EagleNests **********/
                
                lyrEagleNests = new L.GeoJSON.AJAX('data/wildlife_eagle.geojson', {
                    pointToLayer: returnEagleMarker,
                    filter: filterEagleNests
                }).addTo(mymap);
                
                lyrEagleNests.on('data:loaded', function(){
                    arEagleIDs.sort(function(a, b){return a-b});
                    $('#txtFindEagle').autocomplete({
                       source: arEagleIDs 
                    });    
                });
                
                /* Relocate to eagle layer */
//                lyrEagleNests.on('data:loaded', function(){
//                   mymap.fitBounds(lyrEagleNests.getBounds()); 
//                });
                
                
                /********** Layer RaptorNests **********/
                lyrMarkerCluster = L.markerClusterGroup();
                
                lyrRaptorNests = new L.GeoJSON.AJAX('data/wildlife_raptor.geojson', {
                    pointToLayer: returnRaptorNests,
                    filter: filterRaptorNests
                });
                                
                lyrRaptorNests.on('data:loaded', function(){
//                   lyrRaptorNests.addTo(mymap);
                    arRaptorIDs.sort(function(a, b){return a-b});
                    $('#txtFindRaptor').autocomplete({
                       source: arRaptorIDs
                    });   
                    lyrMarkerCluster.addLayer(lyrRaptorNests);
                    lyrMarkerCluster.addTo(mymap);
                });
                
                
                /********** Layer ClientLines **********/
                lyrClientLinesBuffer = L.featureGroup();
                lyrClientLines = new L.GeoJSON.AJAX('data/client_lines.geojson', {
                    style: styleClientLinears, 
                    onEachFeature: processClientLinears,
                    filter: filterClientLinears
                }).addTo(mymap);
                
                lyrClientLines.on('data:loaded', function(){
                    // sort the array - sorted by text (199 > 21)
                    // sort numerically
                    arProjectIDs.sort(function(a, b){return a-b});
                    var arProjectautoIDs = [];
                    $('#txtFindProject').autocomplete({
                       source: arProjectIDs 
                    });
                    lyrClientLinesBuffer.addTo(mymap);
                    lyrClientLines.bringToFront();
                });
                
                /********** Layer BUOWL **********/
                lyrBUOWL = new L.GeoJSON.AJAX('data/wildlife_buowl.geojson', {
                    style: styleBUOWL, 
                    onEachFeature: processBUOWL,
                    filter: filterBUOWL
                }).addTo(mymap);
                
                lyrBUOWLbuffer = L.featureGroup();
                lyrBUOWL.on('data:loaded', function(){
                    arHabitatIDs.sort(function(a, b){return a-b});
                    $('#txtFindBUOWL').autocomplete({
                       source: arHabitatIDs 
                    });
                    // Conver the leaflet geometry object [lyrBUOWL] to GeoJSON 
                    var jsnbuffer = turf.buffer(lyrBUOWL.toGeoJSON(), 0.3, {units: 'kilometers'});
                    var lyrbuffer = L.geoJSON(jsnbuffer, {style: {color: 'CORAL', dashArray: '5, 5', fillOpacity: 0}}).addTo(mymap);
                    lyrBUOWLbuffer.addLayer(lyrbuffer);
                    // Add BUOWLbuffer on top of BUOWL, the BUOWL's tooltip won't work > bring it to front
                    lyrBUOWL.bringToFront();
                });
                
                /********** Layer GBH **********/
                lyrGBH = new L.GeoJSON.AJAX('data/wildlife_gbh.geojson', {
                    style: {
                        color: 'fuchsia'
                    }
                }).bindTooltip('GBH Nesting Area').addTo(mymap);

                
                /********** Setup Layer Control **********/                
                
                objBasemaps = {
                    'Open Street Maps': lyrOSM,
                    'Topo Map': lyrTopo,
                    'Imagery': lyrImagery,
                    'Outdoors': lyrOutdoors,
                    'Watercolor': lyrWaterColor
                };
                
                objOverlays = {
                    'Eagle Nest': lyrEagleNests,
                    'Raptor Nest': lyrMarkerCluster,
                    'Client Lines': lyrClientLines,
                    'Client Lines Buffer': lyrClientLinesBuffer,
                    'Burrowing Owl Habitat': lyrBUOWL,
                    'Burrowing Owl Habitat Buffer': lyrBUOWLbuffer,
                    'GBH Rookeries': lyrGBH,
                    'Drawn Items': fgpDrawnItems
                };
                
                ctlLayers = L.control.layers(objBasemaps, objOverlays).addTo(mymap);
                
                // Legend
//                ctlLegend = new L.Control.Legend({
//                    position: 'topright',
//                    collapsed: true,
//                    controlButton: {
//                        title: 'Legend'
//                    }
//                }).addTo(mymap);
//                
//                $('.legend-container').append($('#legend'));
//                $(".legend-toggle").append("<i class='fa fa-server' style='color: #000'></i>");
                
                /********** Setup Draw Control **********/         
                
                ctlDraw = new L.Control.Draw({
                    draw: {
                        polygon: false,
                        circle: false,
                        rectangle: false
                    },
                    edit: {
                        featureGroup: fgpDrawnItems,
                    }
                });
                ctlDraw.addTo(mymap);
                
                
                mymap.on('draw:created', function(e){
                    // Specify which feature type are drawn - layerType
                    if (e.layerType == 'marker') {
                        var llRef = e.layer.getLatLng();
                        var strTable = '<table class="table table-hover">';
                        strTable += '<tr><th>Constraint</th><th>ID</th><th>Type</th><th>Distance</th><th>Direction</th></tr>'
                        var nrBUOWL = returnClosestLayer(lyrBUOWL, llRef);
                        strTable += '<tr><td>BUOWL</td><td>' + nrBUOWL.att.habitat_id + '</td><td>' + nrBUOWL.att.recentstatus + '</td><td>' + nrBUOWL.distance.toFixed(0) + 'm</td><td>' + nrBUOWL.bearing.toFixed(0) + '</td></tr>';

                        var nrEagle = returnClosestLayer(lyrEagleNests, llRef);
                        strTable += '<tr><td>Eagle Nest</td><td>' + nrEagle.att.nest_id + '</td><td>' + nrEagle.att.status + '</td><td>' + nrEagle.distance.toFixed(0) + 'm</td><td>' + nrEagle.bearing.toFixed(0) + '</td></tr>';

                        var nrRaptor = returnClosestLayer(lyrRaptorNests, llRef);
                        strTable += '<tr><td>Raptor Nest</td><td>' + nrRaptor.att.Nest_ID + '</td><td>' + nrRaptor.att.recentstatus + '<br>' + nrRaptor.att.recentspecies + '</td><td>' + nrRaptor.distance.toFixed(0) + 'm</td><td>' + nrRaptor.bearing.toFixed(0) + '</td></tr>';

                        var nrGBH = returnClosestLayer(lyrGBH, llRef);
                        strTable += '<tr><td>GBH Rookery</td><td>N/A</td><td>N/A</td><td>' + (nrGBH.distance+250).toFixed(0) + 'm</td><td>' + nrGBH.bearing.toFixed(0) + '</td></tr>';
                        strTable += '</table>';
    //                    fgpDrawnItems.addLayer(e.layer.bindPopup(e.layer.getLatLng().toString()));
                        fgpDrawnItems.addLayer(e.layer.bindPopup(strTable, {maxWidth: 400}));                        
                    } else if (e.layerType == 'polyline') {
                        var line = e.layer.toGeoJSON();
                        // Eagle Nests
                        var colEagle = summarizePointByLine(line, 0.8, lyrEagleNests.toGeoJSON(), 'status');
                        var sumEagle = summarizeArray(colEagle.features[0].properties.statusVals);
                        strPopup = 'Eagles';
                        for (var i = 0; i < sumEagle[0].length; i++) {
                            strPopup += '<br>' + sumEagle[0][i] + ': ' + sumEagle[1][i];
                        }
                        
                        // Red-Tail Hawk
                        var arRTH = returnLayersByAttribute(lyrRaptorNests, 'recentspecies', 'Red-tail Hawk');
                        var fcRTH = L.featureGroup(arRTH).toGeoJSON();
                        var colRTH = summarizePointByLine(line, 0.533, fcRTH, 'recentstatus');
                        var sumRTH = summarizeArray(colRTH.features[0].properties.recentstatusVals);
                        strPopup += '<br>Hawks<br>&nbsp;&nbsp;Red-tail Hawk';
                        for (var i = 0; i < sumRTH[0].length; i++) {
                            strPopup += '<br>&nbsp;&nbsp;&nbsp;&nbsp;' + sumRTH[0][i] + ': ' + sumRTH[1][i];
                        }
                        
                        // Swainsons Hawk
                        var arSWH = returnLayersByAttribute(lyrRaptorNests, 'recentspecies', 'Swainsons Hawk');
                        var fcSWH = L.featureGroup(arSWH).toGeoJSON();
                        var colSWH = summarizePointByLine(line, 0.533, fcSWH, 'recentstatus');
                        var sumSWH = summarizeArray(colSWH.features[0].properties.recentstatusVals);
                        strPopup += '<br>&nbsp;&nbsp;Swainsons Hawk';
                        for (var i = 0; i < sumSWH[0].length; i++) {
                            strPopup += '<br>&nbsp;&nbsp;&nbsp;&nbsp;' + sumSWH[0][i] + ': ' + sumSWH[1][i];
                        }
                        
                        var bufLine = turf.buffer(line, 0.05, {unit: 'kilometers'});
                        var intBUOWL = intersectPolyByPolyFC(bufLine, lyrBUOWL.toGeoJSON());
                        var intBUOWLline = intersectLineByPolyFC(line, lyrBUOWLbuffer.toGeoJSON());
                            
                        L.geoJSON(intBUOWL, {style:{color:'red', weight:5}}).addTo(mymap);
                        L.geoJSON(intBUOWLline, {style:{color:'MEDIUMVIOLETRED', weight:5}}).addTo(mymap);
                        
                        var sumBUOWL = summarizePolygFC(intBUOWL, 'hist_occup');
                        strPopup += '<br>Burrowing Owl<br>&nbsp;&nbsp;Direct Impacts';
                        for (var i = 0; i < sumBUOWL[0].length; i++) {
                            strPopup += '<br>&nbsp;&nbsp;&nbsp;&nbsp;' + sumBUOWL[0][i] + ': ' + sumBUOWL[1][i] + '(' + (sumBUOWL[2][i]/4046.9).toFixed(1) + ' acres)';
                        }
                        
                        var sumBUOWL = summarizeLineFC(intBUOWLline, 'hist_occup');
                        strPopup += '<br>&nbsp;&nbsp;Indirect Impacts';
                        for (var i = 0; i < sumBUOWL[0].length; i++) {
                            strPopup += '<br>&nbsp;&nbsp;&nbsp;&nbsp;' + sumBUOWL[0][i] + ': ' + sumBUOWL[1][i] + ' (' + (sumBUOWL[2][i]).toFixed(3) + ' km)';
                        }
                        
                        fgpDrawnItems.addLayer(e.layer.bindPopup(strPopup, {maxWidth: 200}));
                        e.layer.openPopup();
                    }

                });
                
                /********** Location Events **********/
                
                mymap.on('locationfound', function(e){
                    if (mrkCurrentLocation) {
                        mrkCurrentLocation.remove();
                    }
                    /* mrkCurrentLocation = L.circleMarker(e.latlng).addTo(mymap); */
                    mrkCurrentLocation = L.circle(e.latlng, {radius: e.accuracy/2}).addTo(mymap);
                    mymap.setView(e.latlng, 14);
                });
                
                mymap.on('locationerror', function(e){
                    alert('Location was not found.');
                });
            });
            
            /********** BUOWL Functions **********/  
            
            $('#btnBUOWL').click(function(){
               $('#legendBUOWLDetail').toggle(); 
            });
            
            function styleBUOWL(json) {
                var att = json.properties;
                switch (att.hist_occup) {
                    case 'Yes':
                        return {color: 'deeppink', fillColor: 'yellow'};
                        break;
                    case 'Undetermined':
                        return {color: 'yellow'};
                        break;
                }
            }

            function processBUOWL(json, lyr) {
                var att = json.properties;
                lyr.bindTooltip('<h5>Habitat ID: ' + att.habitat_id + '</h4>Historically Occupied: ' + att.hist_occup + '<br>Status: ' + att.recentstatus);
                arHabitatIDs.push(att.habitat_id.toString());
            }

            function filterBUOWL(json) {
                var att = json.properties;
                if (att.recentstatus == 'REMOVE') {
                    return false;
                } else {
                    var optFilter = $('input[name=fltBUOWL]:checked').val();
                    if (optFilter == 'ALL') {
                        return true;
                    } else {
                        return (att.hist_occup == optFilter);
                    }
                }
            } 
            
            $('#txtFindBUOWL').on('keyup paste', function(){
                var val = $(this).val();
                testLayerAttribute(arHabitatIDs, val, 'Habitat ID', '#divFindBUOWL', '#divBUOWLError', '#btnFindBUOWL');
            });
            
            $('#btnFindBUOWL').click(function(){
                var val = $('#txtFindBUOWL').val();
                var lyr = returnLayerByAttribute(lyrBUOWL, 'habitat_id', val);
                if (lyr) {
                    if (lyrSearch) {
                        lyrSearch.remove();
                    }
                    lyrSearch = L.geoJSON(lyr.toGeoJSON(), {
                        style: {
                            color: 'red',
                            weight: 10,
                            opacity: 0.5
                        }
                    }).addTo(mymap);
                    mymap.fitBounds(lyr.getBounds().pad(1));
                    var att = lyr.feature.properties;
                    $('#divBUOWLData').html('<h4 class="text-center">Attributes</h4><h5>Habitat: ' + att.habitat + '</h5><h5>Historically Occupied: ' + att.his_occup + '</h5><h5>Recent Status: ' + att.recentstatus + '</h5>');
                    
                    // Clear out the fgpDrawnItems group
                    fgpDrawnItems.clearLayers();
                    // Pass the layer we've searched for 
                    fgpDrawnItems.addLayer(lyr);
                }
                else {
                    $('#divBUOWLError').css({'visibility': 'visible'});
                }
            });
            
            $('input[name=fltBUOWL]').click(function(){
                if (lyrSearch) {
                    lyrSearch.remove();
                }
                arHabitatIDs = [];
                lyrBUOWL.refresh();
            });
            
            $('#lblBUOWL').click(function(){
                $('#divBUOWLData').toggle(); 
            });
            
            /********** ClientLinears Functions **********/
            
            $('#btnLinearProjects').click(function(){
               $('#legendLinearProjectsDetail').toggle(); 
            });
            
            function styleClientLinears(json) {
                var att = json.properties;
                switch (att.type) {
                    case 'Pipeline':
                        return {color: 'peru'};
                        break;
                    case 'Flowline':
                        return {color: 'navy'};
                        break;
                    case 'Flowline, est.':
                        return {color: 'navy', dashArray: '5, 5'};
                        break;
                    case 'Electric Line':
                        return {color: 'darkgreen'};
                        break;
                    case 'Access Road - confirmed':
                        return {color: 'darkred'};
                        break;
                    case 'Access Road - Estimated':
                        return {color: 'darkred', dashArray: '5, 5'};
                        break; 
                    case 'Extraction':
                        return {color: 'indigo'};
                        break;
                    default:
                        return {color: 'darkgoldenrod'};
                        break;
                }
            }

            // Polyline - getLatLngs() function reutrn an array or array of array
            function processClientLinears(json, lyr) {
                var att = json.properties;
                lyr.bindTooltip('<h5>Linear Project: ' + att.Project + '</h4>Type: ' + att.type + '<br>Row Width: ' + att.row_width + '<br>Length: ' + returnMultiLength(lyr.getLatLngs()).toFixed(0));
                arProjectIDs.push(att.Project.toString());

                var jsnBuffer = turf.buffer(json, att.row_width/1000, {units: 'kilometers'});
                var lyrBuffer = L.geoJSON(jsnBuffer, {style: {color: 'GRAY', dashArray: '5, 5'}});
                lyrClientLinesBuffer.addLayer(lyrBuffer);
            }
            
            function filterClientLinears(json) {
                var att = json.properties;
                arProjectFilters = [];
                $('input[name=fltProject]').each(function(){
                   if (this.checked) {
                       arProjectFilters.push(this.value);
                   } 
                });
                switch (att.type) {
                    case 'Pipeline':
                        return (arProjectFilters.indexOf('Pipeline') != -1);
                        break;
                    case 'Flowline': 
                        return (arProjectFilters.indexOf('Flowline') != -1);
                        break;
                    case 'Flowline, est.': 
                        return (arProjectFilters.indexOf('Flowline') != -1);
                        break;
                    case 'Electric Line': 
                        return (arProjectFilters.indexOf('Electric') != -1);
                        break;
                    case 'Access Road - Confirmed': 
                        return (arProjectFilters.indexOf('Road') != -1);
                        break;
                    case 'Access Road - Estimated': 
                        return (arProjectFilters.indexOf('Road') != -1);
                        break;
                    case 'Extraction': 
                        return (arProjectFilters.indexOf('Extraction') != -1);
                        break;
                    default:
                        return (arProjectFilters.indexOf('Other') != -1);
                        break;
                }
            }
            
            
//            function returnClientLineByID(id) {
//                // The feature ID is numeric type but the id retrieved from textbox is string. 
//                // if using === here, it will always be false. 
//                // Using == then JavaScript will automatically perform a conversion.
//                var arLayers = lyrClientLines.getLayers();
//                for (i = 0; i < arLayers.length - 1; i++) {
//                    var featureID = arLayers[i].feature.properties.Project;
//                    if (featureID == id) {
//                        return arLayers[i];
//                    }
//                }
//                return false;
//            }
            
//            function testClientLineID(id) {
//                // ID is not found
//                if (arProjectIDs.indexOf(id) == -1) {
//                    $('#divFindProject').addClass('has-error');
//                    $('#divProjectError').css({'visibility': 'visible'});
//                    $('#btnFindProject').attr('disabled', true);
//                } else {
//                    $('#divFindProject').removeClass('has-error');
//                    $('#btnFindProject').attr('disabled', false);
//                }
//            }
            
            $('#txtFindProject').on('keyup paste', function(){
//               testClientLineID($(this).val()); 
                var val = $(this).val();
                testLayerAttribute(arProjectIDs, val, 'Project ID', '#divFindProject', '#divProjectError', '#btnFindProject');
            });
            
            $('#btnFindProject').click(function(){
                var val = $('#txtFindProject').val();
//                var lyr = returnClientLineByID(id);
                var lyr = returnLayerByAttribute(lyrClientLines, 'Project', val);
                if (lyr) {
                    if (lyrSearch) {
                        lyrSearch.remove();
                    }
                    lyrSearch = L.geoJSON(lyr.toGeoJSON(), {
                        style: {
                            color: 'red',
                            weight: 10,
                            opacity: 0.5
                        }
                    }).addTo(mymap);
                    // The pad method can help use see what exact feature we're looking for
                    // but we don't zoom in too far and get too much detail. 
                    mymap.fitBounds(lyr.getBounds().pad(1));
                    var att = lyr.feature.properties;
                    $('#divProjectData').html('<h4 class="text-center">Attributes</h4><h5>Type: ' + att.type + '</h5><h5>Row width: ' + att.row_width + 'm</h5>');
                    
                    // Clear out the fgpDrawnItems group
                    fgpDrawnItems.clearLayers();
                    // Pass the layer we've searched for 
                    fgpDrawnItems.addLayer(lyr);
                }
                else {
                    $('#divProjectError').css({'visibility': 'visible'});
                }
            });
            
            $('#lblProject').click(function(){
                $('#divProjectData').toggle(); 
            });
            
            // Check All
            $('#btnProjectFilterAll').click(function(){
                $('input[name=fltProject]').prop('checked', true);
            });
            
            // Uncheck all
            $('#btnProjectFilterNone').click(function(){
                $('input[name=fltProject]').prop('checked', false);
            });
            
            $('#btnProjectFilter').click(function(){
                if (lyrSearch) {
                    lyrSearch.remove();
                }
                arProjectIDs = [];
                lyrClientLines.refresh();
            });
            
            /********** Eagle Functions **********/
            
            $('#btnEagle').click(function(){
               $('#legendEagleDetail').toggle(); 
            });
            
            /* This function runs on every single geojson object */
            function returnEagleMarker(json, latlng){
                /* attribute data */
                var att = json.properties;
                if (att.status == 'ACTIVE NEST') {
                    var clrNest = 'LIGHTPINK';
                } else {
                    var clrNest = 'OLIVEDRAB';
                }
                arEagleIDs.push(att.nest_id.toString());
                console.log(arEagleIDs);
                return L.circle(latlng, {radius: 804, color: clrNest, fillColor: 'DARKOLIVEGREEN', fillOpacity: 0.5}).bindTooltip('<h5>Eagle Nest: ' + att.nest_id + '</h5>Status: ' + att.status);
            }
            
            function filterEagleNests(json) {
                var att = json.properties;
                var optFilter = $('input[name=fltEagle]:checked').val();
                if (optFilter == 'ALL') {
                    return true;
                } else {
                    return (att.status == optFilter);
                }
            }
            
            $('#txtFindEagle').on('keyup paste', function(){
                var val = $(this).val();
                testLayerAttribute(arEagleIDs, val, 'Eagle Nest ID', '#divFindEagle', '#divEagleError', '#btnFindEagle');
            });
            
            $('#btnFindEagle').click(function(){
                var val = $('#txtFindEagle').val();
                var lyr = returnLayerByAttribute(lyrEagleNests,'nest_id',val);
                var att = lyr.feature.properties;
                if (lyr) {
                    if (lyrSearch) {
                        lyrSearch.remove();
                    }
                    lyrSearch = L.circle(lyr.getLatLng(), {radius:800, color:'red', weight:10, opacity:0.5, fillOpacity:0});
                    lyrSearch.addTo(mymap);
                    mymap.setView(lyr.getLatLng(), 14);
                    $("#divEagleData").html("<h4 class='text-center'>Attributes</h4><h5>Status: "+att.status+"</h5>");
                    
                    // Clear out the fgpDrawnItems group
                    fgpDrawnItems.clearLayers();
                    // Pass the layer we've searched for 
                    fgpDrawnItems.addLayer(lyr);
                } else {
                    $('#divEagleError').css({'visibility': 'visible'});
                }
            });
            
            $('#lblEagle').click(function(){
                $('#divEagleData').toggle(); 
            });
            
            $('input[name=fltEagle]').click(function(){
                if (lyrSearch) {
                    lyrSearch.remove();
                }
                arEagleIDs = [];
                lyrEagleNests.refresh();
            });

            /* Returns true or false to determine if it includes the data*/
//                function filterEagleNests(json){
//                    var att = json.properties;
//                    if (att.status == 'ACTIVE NEST') {
//                        return true;
//                    } else {
//                        return false;
//                    }
//                }
            
            /********** Raptor Functions **********/
            
            $('#btnRaptor').click(function(){
               $('#legendRaptorDetail').toggle(); 
            });
            
            function returnRaptorNests(json, latlng){
                var att = json.properties;
                arRaptorIDs.push(att.Nest_ID.toString());
                switch (att.recentspecies) {
                    case 'Red-tail Hawk':
                        var radRaptor = 533;
                        break;
                    case 'Swainsons Hawk':
                        var radRaptor = 400;
                        break;
                    default:
                        var radRaptor = 804;
                        break;
                }
                switch (att.recentstatus) {
                    case 'ACTIVE NEST':
                        var optRaptor = {
                            radius: radRaptor, 
                            color: 'INDIANRED', 
                            fillColor: 'blue',
                            opacity: 0.5
                        };
                        break;
                    case 'INACTIVE NEST': 
                        var optRaptor = {
                            radius: radRaptor, 
                            color: 'blue', 
                            fillColor: 'blue',
                            opacity: 0.5
                        };
                        break;
                    case 'FLEDGED NEST': 
                        var optRaptor = {
                            radius: radRaptor, 
                            color: 'blue', 
                            fillColor: 'blue',
                            opacity: 0.5,
                            dashArray: '2, 8'
                        };
                        break;
                }
                return L.circle(latlng, optRaptor).bindPopup('<h5>Raptor Nest: ' + att.Nest_ID + '</h5>Status: ' + att.recentstatus + '<br>Species: ' + att.recentspecies + '<br>Last Survey: ' + att.lastsurvey);
            }
            
            function filterRaptorNests(json) {
                var att=json.properties;
                var optFilter = $("input[name=fltRaptor]:checked").val();
                if (optFilter=='ALL') {
                    return true;
                } else {
                    return (att.recentstatus==optFilter);
                }
            }
            
            $('#txtFindRaptor').on('keyup paste', function(){
                var val = $(this).val();
                testLayerAttribute(arRaptorIDs, val, 'Raptor Nest ID', '#divFindRaptor', '#divRaptorError', '#btnFindRaptor');
            });
            
            $('#btnFindRaptor').click(function(){
                var val = $('#txtFindRaptor').val();
                var lyr = returnLayerByAttribute(lyrRaptorNests, 'Nest_ID',val);
                if (lyr) {
                    if (lyrSearch) {
                        lyrSearch.remove();
                    }
                    var att = lyr.feature.properties;
                    switch (att.recentspecies) {
                        case 'Red-tail Hawk':
                            var radRaptor = 533;
                            break;
                        case 'Swainsons Hawk':
                            var radRaptor = 400;
                            break;
                        default:
                            var radRaptor = 804;
                            break;
                    }
                    lyrSearch = L.circle(lyr.getLatLng(), {radius:radRaptor, color:'red', weight:10, opacity:0.5, fillOpacity:0}).addTo(mymap);
                    mymap.setView(lyr.getLatLng(), 14);
                    $('#divRaptorData').html("<h4 class='text-center'>Attributes</h4><h5>Status: "+att.recentstatus+"</h5><h5>Species: "+att.recentspecies+"</h5><h5>Last Survey: "+att.lastsurvey+"</h5>");
                    
                    // Clear out the fgpDrawnItems group
                    fgpDrawnItems.clearLayers();
                    // Pass the layer we've searched for 
                    fgpDrawnItems.addLayer(lyr);
                } else {
                    $('#divRaptorError').css({'visibility': 'visible'});
                }
            });
            
            $('#lblRaptor').click(function(){
                $('#divRaptorData').toggle(); 
            });
            
            $('input[name=fltRaptor]').click(function(){
                if (lyrSearch) {
                    lyrSearch.remove();
                }
                arRaptorIDs = [];
                lyrRaptorNests.refresh();
            });
            
            /********** jQuery Event Handlers **********/  
            
            $('#btnLocate').click(function(){
                mymap.locate(); 
            });
            
            $('#btnShowLegend').click(function(){
               $('#legend').toggle(); 
            });
            
            $('#btnClear').click(function(){
                lyrClientLines.refresh();
                lyrEagleNests.refresh();
                lyrBUOWL.refresh();
                lyrRaptorNests.refresh();
                mymap.setView([40.18, -105.03], 11);
            });
            
            /********** General Functions **********/ 
            
            function returnLayerByAttribute(lyr, att, val) {
                var arLayers = lyr.getLayers();
                for (i = 0; i < arLayers.length - 1; i++) {
                    var featureVal = arLayers[i].feature.properties[att];
                    if (featureVal == val) {
                        return arLayers[i];
                    } 
                }
                return false;
            }
            
            function returnLayersByAttribute(lyr, att, val) {
                var arLayers = lyr.getLayers();
                var arMatches = [];
                for (i = 0; i < arLayers.length - 1; i++) {
                    var featureVal = arLayers[i].feature.properties[att];
                    if (featureVal == val) {
                        arMatches.push(arLayers[i]);
                    } 
                }
                if (arMatches.length) {
                    return arMatches;
                } else {
                    return false;
                }
            }
            
            function testLayerAttribute(ar, val, att, fg, err, btn) {
                if (ar.indexOf(val) != -1) {
                    $(fg).removeClass('has-error');
                    $(err).css({'visibility': 'hidden'});
                    $(btn).attr('disabled', false);
                } else if (!val) {
                    $(fg).removeClass('has-error');
                    $(err).css({'visibility': 'hidden'});
                    $(btn).attr('disabled', true);
                } else {
                    $(fg).addClass('has-error');
                    $(err).css({'visibility': 'visible'});
                    $(btn).attr('disabled', true);
                }
            }
            
            function returnLength(arLL) {
                var total = 0;
                for (var i = 1; i < arLL.length; i++) {
                    // Start with the distance between the first and second LatLng
                    total = total + arLL[i-1].distanceTo(arLL[i]);
                }
                return total;
            }
            
            // GeoJson stores multipolylines - array of array
            function returnMultiLength(arArLL) {
                var total = 0;
                for (var i = 0; i < arArLL.length; i++) {
                     total = total + returnLength(arArLL[i]);
                }
                return total;
            }
            
            // Searching for the layer in the array of layer that's closest to this point. 
            function returnClosestLayer(lyrGroup, llRef) {
                // Returns the array of layers
                var arLyrs = lyrGroup.getLayers();
                var nearest = L.GeometryUtil.closestLayer(mymap, arLyrs, llRef);
                nearest.distance = llRef.distanceTo(nearest.latlng);
                nearest.bearing = L.GeometryUtil.bearing(llRef, nearest.latlng);
                if (nearest.bearing < 0) {
                    nearest.bearing = nearest.bearing + 360;
                }
                nearest.att = nearest.layer.feature.properties;
                return nearest;
            }
            
            function summarizePointByLine(line, radius, fcPoint, prop) {
                var buf = turf.buffer(line, radius, {unit: 'kilometers'});
                buf = turf.featureCollection([buf]);
                buf = turf.collect(buf, fcPoint, prop, prop+'Vals');
                return buf;
            }
            
            function intersectPolyByPolyFC(poly, fcPoly) {
                var fgp = [];
                // a polygon representation of the bounding box of reference polygon
                var bbPoly = turf.bboxPolygon(turf.bbox(poly));
                for (var i = 0; i < fcPoly.features.length; i++) {
                    var bb = turf.bboxPolygon(turf.bbox(fcPoly.features[i]));
                    if (turf.intersect(bbPoly, bb)) {
                        var int = turf.intersect(poly, fcPoly.features[i]);
                        // test if reference polygon and polygon feature collection actually intersects
                        if (int) {
                            // int doesn't contain any property from polygon feature
                            int.properties = fcPoly.features[i].properties;
                            fgp.push(int);
                        }
                    }
                }
                // return feature collection
                return turf.featureCollection(fgp);
            }

            
            function summarizeArray(ar) {
                var arUnique = [];
                var arCount = [];
                for (let i = 0; i < ar.length; i++) {
                    var index = arUnique.indexOf(ar[i]);
                    if (index == -1) {
                        arUnique.push(ar[i]);
                        arCount.push(1);
                    } else {
                        arCount[index] = arCount[index] + 1;
                    }
                }
                return [arUnique, arCount];
            }
            
            function summarizePolygFC(fcPoly, att) {
                var arUnique = [];
                var arCount = [];
                var arArea = [];
                for (let i = 0; i < fcPoly.features.length; i++) {
                    var curAtt = fcPoly.features[i].properties[att]
                    var index = arUnique.indexOf(curAtt);
                    var area = turf.area(fcPoly.features[i]);
                    if (index == -1) {
                        arUnique.push(curAtt);
                        arCount.push(1);
                        arArea.push(area)
                    } else {
                        arCount[index] = arCount[index] + 1;
                        arArea[index] = arArea[index] + area;
                    }
                }
                return [arUnique, arCount, arArea];
            }  
            
            function intersectLineByPolyFC(line, fcPoly) {
                var fgp = [];
                // a polygon representation of the bounding box of reference polygon
                var bbLine = turf.bboxPolygon(turf.bbox(line));
                for (var i = 0; i < fcPoly.features.length; i++) {
                    var bb = turf.bboxPolygon(turf.bbox(fcPoly.features[i]));
                    if (turf.intersect(bbLine, bb)) {
                        var slc = turf.lineSplit(line, fcPoly.features[i]);
                        for (var j = 0; j < slc.features.length; j++) {
                            if (turf.booleanWithin(slc.features[j], fcPoly.features[i])) {
                                slc.features[j].properties = fcPoly.features[i].properties;
                                fgp.push(slc.features[j]);
                            }
                        }
                    }
                }
                // return feature collection
                return turf.featureCollection(fgp);
            }
            
            function summarizeLineFC(fcLine, att) {
                var arUnique = [];
                var arCount = [];
                var arLength = [];
                for (let i = 0; i < fcLine.features.length; i++) {
                    var curAtt = fcLine.features[i].properties[att]
                    var index = arUnique.indexOf(curAtt);
                    var length = turf.length(fcLine.features[i], {unit: 'kilometers'});
                    if (index == -1) {
                        arUnique.push(curAtt);
                        arCount.push(1);
                        arLength.push(length)
                    } else {
                        arCount[index] = arCount[index] + 1;
                        arLength[index] = arLength[index] + length;
                    }
                }
                return [arUnique, arCount, arLength];
            }
        </script>
    </body>
</html>